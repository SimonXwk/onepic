<div class="container-fluid">

	<!-- Pagination -->
	{% with  %}
		{#	Find Current Item	#}
		{% if not request.view_args['fy'] %} {% set active_item = thisfy  %}
		{% else %} {% set active_item = request.view_args['fy']  %}
		{% endif %}
		{#	Find Page List	#}
		{% set items = fys|map(attribute='FY')|list %}
		{# How to display each page #}
		{% macro page_dispaly(pagination_item) %}
			FY{{ (pagination_item|string)[-2:] }}
		{% endmacro %}
		{#	--------- End of Input --------- #}

		{# Middle Items #}
		{% set middle_item = items[((items|length)/2)|int] %}
		{#	Find Page List	#}
		{% set is_first = (items[0] == active_item) %}
		{% set is_last = (items[-1] == active_item) %}

	<nav aria-label="...">
		<ul class="pagination pagination-sm mt-3 mr-3">
			<li class="page-item {% if is_first %}disabled{% endif %}">
				<a class="page-link" href="{{ url_for(request.endpoint, fy=items[0]) }}" aria-label="Previous">
					<span aria-hidden="true">&laquo;&laquo;</span>
					<span class="sr-only">First</span>
				</a>
			</li> <!-- End of Pagination[First] -->

			{% if not  is_first %}
			<li class="page-item {% if is_first %}disabled{% endif %}">
				<a class="page-link" href="{{ url_for(request.endpoint, fy=active_item - 1) }}" aria-label="Previous">
					<span aria-hidden="true">&laquo;</span>
					<span class="sr-only">Previous</span>
				</a>
			</li> <!-- End of Pagination[Previous] -->
			{% endif %}

			{% if items|length < 5 %}
				{% for item in items %}
					<li class="page-item {% if item == active_item %}active{% endif %}">
						<a class="page-link" href="{{ url_for(request.endpoint, fy=item) }}">
							 {% if item == this_fy %}<span class="sr-only">(current)</span>{% endif %}{{ page_dispaly(item) }}
						</a>
					</li>
				{% endfor %}

			{% else %}
				{% if active_item in (items[0], items[1], items[2]) %}
					{% for item in items[:3] %}
					<li class="page-item {% if item == active_item %}active{% endif %}">
						<a class="page-link" href="{{ url_for(request.endpoint, fy=item) }}">
							 {% if item == active_item %}<span class="sr-only">(current)</span>{% endif %}{{ page_dispaly(item) }}
						</a>
					</li>
					{% endfor %}
					<li class="page-item disabled"><a class="page-link" href="">...</a></li>
				{% elif active_item in (items[-1], items[-2], items[-3]) %}
					<li class="page-item disabled"><a class="page-link" href="">...</a></li>
					{% for item in items[-3:] %}
					<li class="page-item {% if item == active_item %}active{% endif %}">
						<a class="page-link" href="{{ url_for(request.endpoint, fy=item) }}">
							 {% if item == active_item %}<span class="sr-only">(current)</span>{% endif %}{{ page_dispaly(item) }}
						</a>
					</li>
					{% endfor %}
				{% else %}
					<li class="page-item disabled"><a class="page-link" href="">..</a></li>
					<li class="page-item">
						<a class="page-link" href="{{ url_for(request.endpoint, fy=active_item - 1) }}">
							<span class="sr-only">(current)</span>{{ page_dispaly(active_item - 1) }}
						</a>
					</li>
					<li class="page-item active">
						<a class="page-link" href="{{ url_for(request.endpoint, fy=active_item) }}">
							<span class="sr-only">(current)</span>{{ page_dispaly(active_item) }}
						</a>
					</li>
					<li class="page-item">
						<a class="page-link" href="{{ url_for(request.endpoint, fy=active_item + 1) }}">
							<span class="sr-only">(current)</span>{{ page_dispaly(active_item + 1) }}
						</a>
					</li>
					<li class="page-item disabled"><a class="page-link" href="">..</a></li>
				{% endif %}
			{% endif %}

			{% if not  is_last %}
			<li class="page-item {% if is_last %}disabled{% endif %}">
				<a class="page-link" href="{{ url_for(request.endpoint, fy=active_item + 1) }}" aria-label="Next">
					<span aria-hidden="true">&raquo;</span>
					<span class="sr-only">Next</span>
				</a>
			</li><!-- End of Pagination[Next] -->
			{% endif %}
			<li class="page-item {% if is_last %}disabled{% endif %}">
				<a class="page-link" href="{{ url_for(request.endpoint, fy=items[-1]) }}" aria-label="Previous">
					<span aria-hidden="true">&raquo;&raquo;</span>
					<span class="sr-only">Last</span>
				</a>
			</li> <!-- End of Pagination[Last] -->
		</ul>
	</nav>
	{% endwith  %}<!-- End of Pagination -->


	<p class="lead">
		<h5>TLMA Revenue Streams for FY{{ thisfy }} <span class="text-info">{# (Total {{ data.rows|sum(attribute='TOTAL')|currency }})  #}</span>
		</h5>
		(data captured : {{ data.timestamp|dtAU }}, cached for {{ '{:,}'.format(data.cached_timeout) }} seconds)
	</p>

	<!-- ROW -->
	<div class="row">
		<div class="col-md-12">
			<div class="chart" id="chart1" ></div>
		</div>
	</div> <!-- END OF ROW -->

	<hr	/>

	<!-- ROW -->
	<div class="row">
		<div class="col-md-12">
			<div class="chart" id="chart2" ></div>
		</div>
	</div> <!-- END OF ROW -->

{#	{{ prototype('data_table') }}#}


</div>


<script>
let fy = {{ thisfy }} ;
let nodes = {
	'TLMA': {
		color: '#be0027',
  },
	'Solicited': {
		color: '#3be8b0',
  },
	'Unlv1ed': {
		color: '#cccccc',
  },
	'Merchandise Platform': {
		color: '#a560e8',
  },
	'Non-Merchandise Platform': {
		color: '#ffb900',
  },
	'Donation': {
		color: '#05cc47',
  },
	'Bequest': {
		color: '#0d9ddb',
  },
	'Group': {
		color: '#7d0100',
  },
	'Purchase-Postage': {
		color: '#2f6f7e',
  },
	'Pledge': {
		color: '#ed008c',
  },

	'General 1': {
		color: '#f5de50',
  },
	'General 2': {
		color: '#f5de50',
  },
	'Merchandise': {
		color: '#a560e8',
  },
	'Gift of Love': {
		color: '#ff4400',
  },
	'DONKIND': {
		color: '#79afc1',
  },
	'ELF': {
		color: '#c6af92',
  },
	'India': {
		color: '#bf5b20',
  },
	'Myanmar': {
		color: '#ed008c',
  },
	'Nepal': {
		color: '#5851db',
  },
	'Nigeria': {
		color: '#f9a541',
  },
	'Personal': {
		color: '#606c76',
  },
	'PNG': {
		color: '#56b881',
  },
	'Thailand': {
		color: '#e0d86e',
  },
	'Timor Leste': {
		color: '#00a1e4',
  },
};

let sankeyData = {
	cht1: {
		data:[],
		nodes: {}
	},
	cht2: {
		data:[],
		nodes: {}
	}
};
let currentCht;

function updateSankeyData(sankeyID, col, v1, v2, w, path, isLast) {
	let sankey = sankeyData[sankeyID];
	let idx1 = sankey.data.length;

	sankey.data[idx1] = {
		from: v1,
		to: v2,
		weight: w,
		path: path
	};
	if (!(v1 in sankey.nodes)){
		sankey.nodes[v1] = {
			column: col
		};
		if (v1 in nodes) {
			sankey.nodes[v1].color = nodes[v1].color
		}
	}
	if (isLast){
		if (!(v2 in sankey.nodes)){
			sankey.nodes[v2] = {
			column: col + 1
			};
		}
		if (v2 in nodes) {
			sankey.nodes[v2].color = nodes[v2].color
		}
	}
}

function objToArray(obj){
	 return  Object.keys(obj).map(function(key) {
				return {id: key, color:  obj[key].color, column: obj[key].column};
	 })
}

currentCht = 'cht1';
{% for lv1, lv1List in data.rows|groupby('SOLICIT') %}
updateSankeyData(currentCht, 0, 'TLMA', '{{ lv1 }}', {{ lv1List|sum(attribute='TOTAL') }}, '{{ ('TLMA',lv1)|join(' -> ')|safe }}', false);
	{% for lv2, lv2List in lv1List|groupby('PLATFORM')  %}
	updateSankeyData(currentCht, 1, '{{ lv1 }}', '{{ lv2 }}', {{ lv2List|sum(attribute='TOTAL') }}, '{{ ('TLMA',lv1,lv2)|join(' -> ')|safe }}', false);
		{% for lv3, lv3List in lv2List|groupby('TQTYPE')  %}
		updateSankeyData(currentCht, 2, '{{ lv2 }}', '{{ lv3 }}', {{ lv3List|sum(attribute='TOTAL') }}, '{{ ('TLMA',lv1,lv2,lv3)|join(' -> ')|safe }}', false);
			{% for lv4, lv4List in lv3List|groupby('ACCOUNT')  %}
			updateSankeyData(currentCht, 3, '{{ lv3 }}', '{{ lv4 }}', {{ lv4List|sum(attribute='TOTAL') }}, '{{ ('TLMA',lv1,lv2,lv3,lv4)|join(' -> ')|safe }}', true);
			{% endfor	 %}
		{% endfor	 %}
	{% endfor	 %}
{% endfor	 %}
sankeyData[currentCht].nodes = objToArray(sankeyData[currentCht].nodes);

currentCht = 'cht2';
{% for lv1, lv1List in data.rows|groupby('SOLICIT') %}
updateSankeyData(currentCht, 0, 'TLMA', '{{ lv1 }}', {{ lv1List|sum(attribute='TOTAL') }}, '{{ ('TLMA',lv1)|join(' -> ')|safe }}', false);
	{% for lv2, lv2List in lv1List|groupby('PLATFORM')  %}
	updateSankeyData(currentCht, 1, '{{ lv1 }}', '{{ lv2 }}', {{ lv2List|sum(attribute='TOTAL') }}, '{{ ('TLMA',lv1,lv2)|join(' -> ')|safe }}', false);
		{% for lv3, lv3List in lv2List|groupby('DES1')  %}
		updateSankeyData(currentCht, 2, '{{ lv2 }}', '{{ lv3 }}', {{ lv3List|sum(attribute='TOTAL') }}, '{{ ('TLMA',lv1,lv2,lv3)|join(' -> ')|safe }}', false);
			{% for lv4, lv4List in lv3List|groupby('DES2')  %}
			updateSankeyData(currentCht, 3, '{{ lv3 }}', '{{ lv4 }}', {{ lv4List|sum(attribute='TOTAL') }}, '{{ ('TLMA',lv1,lv2,lv3,lv4)|join(' -> ')|safe }}', true);
			{% endfor	 %}
		{% endfor	 %}
	{% endfor	 %}
{% endfor	 %}
sankeyData[currentCht].nodes = objToArray(sankeyData[currentCht].nodes);



console.log(sankeyData);
</script>
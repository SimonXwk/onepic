<div class="container-fluid">
{% set data_table_id = 'data_table' %}
{% macro filterTable(col, value) %}
	filterTable('{{ data_table_id }}', {{ col }}, '{{ value }}', this)
{% endmacro %}
	<!-- Pagination -->
	{% with  %}
		{#	Find Current Item	#}
		{% if not request.view_args['fy'] %} {% set active_item = this_fy  %}
		{% else %} {% set active_item = request.view_args['fy']  %}
		{% endif %}
		{#	Find Page List	#}
		{% set items = fys|map(attribute='FY')|list %}
		{# How to display each page #}
		{% macro page_dispaly(pagination_item) %}
			FY{{ (pagination_item|string)[-2:] }}
		{% endmacro %}
		{#	--------- End of Input --------- #}
		{# Middle Items #}
		{% set middle_item = items[((items|length)/2)|int] %}
		{#	Find Page List	#}
		{% set is_first = (items[0] == active_item) %}
		{% set is_last = (items[-1] == active_item) %}

	<nav aria-label="...">
		<ul class="pagination pagination-sm mt-3 mr-3">
			<li class="page-item {% if is_first %}disabled{% endif %}">
				<a class="page-link" href="{{ url_for(request.endpoint, fy=items[0]) }}" aria-label="Previous">
					<span aria-hidden="true">&laquo;&laquo;</span>
					<span class="sr-only">First</span>
				</a>
			</li> <!-- End of Pagination[First] -->

			{% if not  is_first %}
			<li class="page-item {% if is_first %}disabled{% endif %}">
				<a class="page-link" href="{{ url_for(request.endpoint, fy=active_item - 1) }}" aria-label="Previous">
					<span aria-hidden="true">&laquo;</span>
					<span class="sr-only">Previous</span>
				</a>
			</li> <!-- End of Pagination[Previous] -->
			{% endif %}

			{% if items|length < 5 %}
				{% for item in items %}
					<li class="page-item {% if item == active_item %}active{% endif %}">
						<a class="page-link" href="{{ url_for(request.endpoint, fy=item) }}">
							 {% if item == this_fy %}<span class="sr-only">(current)</span>{% endif %}{{ page_dispaly(item) }}
						</a>
					</li>
				{% endfor %}

			{% else %}
				{% if active_item in (items[0], items[1], items[2]) %}
					{% for item in items[:3] %}
					<li class="page-item {% if item == active_item %}active{% endif %}">
						<a class="page-link" href="{{ url_for(request.endpoint, fy=item) }}">
							 {% if item == active_item %}<span class="sr-only">(current)</span>{% endif %}{{ page_dispaly(item) }}
						</a>
					</li>
					{% endfor %}
					<li class="page-item disabled"><a class="page-link" href="">...</a></li>
				{% elif active_item in (items[-1], items[-2], items[-3]) %}
					<li class="page-item disabled"><a class="page-link" href="">...</a></li>
					{% for item in items[-3:] %}
					<li class="page-item {% if item == active_item %}active{% endif %}">
						<a class="page-link" href="{{ url_for(request.endpoint, fy=item) }}">
							 {% if item == active_item %}<span class="sr-only">(current)</span>{% endif %}{{ page_dispaly(item) }}
						</a>
					</li>
					{% endfor %}
				{% else %}
					<li class="page-item disabled"><a class="page-link" href="">..</a></li>
					<li class="page-item">
						<a class="page-link" href="{{ url_for(request.endpoint, fy=active_item - 1) }}">
							<span class="sr-only">(current)</span>{{ page_dispaly(active_item - 1) }}
						</a>
					</li>
					<li class="page-item active">
						<a class="page-link" href="{{ url_for(request.endpoint, fy=active_item) }}">
							<span class="sr-only">(current)</span>{{ page_dispaly(active_item) }}
						</a>
					</li>
					<li class="page-item">
						<a class="page-link" href="{{ url_for(request.endpoint, fy=active_item + 1) }}">
							<span class="sr-only">(current)</span>{{ page_dispaly(active_item + 1) }}
						</a>
					</li>
					<li class="page-item disabled"><a class="page-link" href="">..</a></li>
				{% endif %}
			{% endif %}

			{% if not  is_last %}
			<li class="page-item {% if is_last %}disabled{% endif %}">
				<a class="page-link" href="{{ url_for(request.endpoint, fy=active_item + 1) }}" aria-label="Next">
					<span aria-hidden="true">&raquo;</span>
					<span class="sr-only">Next</span>
				</a>
			</li><!-- End of Pagination[Next] -->
			{% endif %}
			<li class="page-item {% if is_last %}disabled{% endif %}">
				<a class="page-link" href="{{ url_for(request.endpoint, fy=items[-1]) }}" aria-label="Previous">
					<span aria-hidden="true">&raquo;&raquo;</span>
					<span class="sr-only">Last</span>
				</a>
			</li> <!-- End of Pagination[Last] -->
		</ul>
	</nav>
	{% endwith  %}<!-- End of Pagination -->

	<!-- Total Income Headline-->
	{% set total_fy =  data.rows|sum(attribute='ACTUAL_TOTAL')  %}
	<p class="lead"><strong>FY{{ this_fy }} Total Sponsorship Income : {{ total_fy|currency }}</strong></p>

	<div class="row">
		<div class="col-sm">
			<!-- Big Type Income Report -->
			<div class="card">
				<div class="table-responsive">
				<table class="table table-hover table-sm table-striped table-bordered">
					<caption><strong>Data Captured : </strong>{{ data.timestamp|dtAU }}, cached for {{ '{:,}'.format(data.cached_timeout) }} seconds
					</caption><!-- End of Table Caption -->
					<thead class="thead-dark">
						<tr>
							<th scope="col">
								<span class="text-warning"
									data-toggle="popover" tabindex="0" data-trigger="focus"
									data-placement="right"
									title="Definition Rules"
									data-content="Interpreting the 1st Sourcecode1 associated to a pledge using following rules from top to bottom<br>
									<ul>
									<li>If it's [TLCSPON] -> [TLC]</li>
									<li>If it's [SACTIONP] -> [ACTION PARTNER]</li>
									<li>If it's [SPERSON] -> [PERSONAL SUPPORT]</li>
									<li>If it's [SCOUNTRY] -> [COUNTRY SUPPORT]</li>
									<li>If it contains [SCURE] -> [CURE ONE]</li>
									<li>If this first sourcecode1 exists --> [_AMBIGUOUS]</li>
									<li>If this first sourcecode1 does not exist --> [_PLEDGE MISSING]</li>
									</ul>
									"
								>
									Sponsorship Type
								</span>
							</th>
							<th scope="col">Total</th>
							<th scope="col">Per Month</th>
							{% for m in fymlist|map("mthname", abbr=True) %}
								<th scope="col">
								{{ m }}
								</th>
							{% endfor %}
						</tr>
					</thead>
					<tbody>
						{% for group in data.rows|groupby('SPONSORSHIP1')%}
						<tr>
							{% set type_total = group.list|sum(attribute='ACTUAL_TOTAL')  %}
							<th scope="col" >
								{{ group.grouper }}
							</th>
							<td><span class="text-primary"><strong>{{ type_total|currency }}</strong></span></td>
							<td><span class="text-primary"><strong>{{ (type_total/12)|currency }}</strong></span></td>

							{% for m in fymlist %}
							<td scope="col">
								{% for group_mth in group.list|groupby('DATEOFPAYMENT.month') %}
									{% set month_total = group_mth.list|sum(attribute='ACTUAL_TOTAL') %}
									{% if group_mth.grouper == m %}
										{{ month_total|currency }}
									{% endif %}
								{% endfor %}
							</td>
							{% endfor %}
						</tr>
						{% endfor %}
					</tbody>
				</table>
				</div>
			</div>
	 	</div>
	</div>

	<div class="row">
		<div class="col-md-4">
			<div class="chart" id="chart1" ></div>
		</div>

		<div class="col-md-8">
			<div class="chart" id="chart2" ></div>
		</div>

	</div>

{#	{{ prototype('data_table') }}#}
</div>

<script>

	let pledgeType1 = [], pledgeMonthlyType1 = [], tempData = [];
	let tempTotal;
	{% for group in data.rows|groupby('SPONSORSHIP1') %}
		{% with %}
			{% set total_type1 = group.list|sum(attribute='ACTUAL_TOTAL') %}
			{% set color_type1 = group.list[0].SPONSORSHIP1_COLOR %}
			pledgeType1[{{ loop.index - 1 }}] = {
				name: '{{ group.grouper }}',
				y: {{ total_type1 }},
				z:{{ (total_type1/total_fy) * 300 + 50 }},
				color: '{{ color_type1  }}'
			};

			tempData = [];
			{% for m in fymlist %}
				{% set month_loop_index = loop.index %}
				tempTotal = null;
					{% for group_mth in group.list|groupby('DATEOFPAYMENT.month') %}
						{% set month_total = group_mth.list|sum(attribute='ACTUAL_TOTAL') %}
						{% if group_mth.grouper == m %}
								{% set total_matched = month_total %}
								tempTotal = {{ month_total }}
						{% endif %}
					{% endfor %}
				tempData[{{ month_loop_index - 1 }}] = tempTotal;
			{% endfor %}

			pledgeMonthlyType1[{{ loop.index - 1 }}] = {
		  name: '{{ group.grouper }}',
		  data: tempData,
			color: '{{ color_type1  }}'
	  };

		{% endwith %}
	{% endfor %}

</script>
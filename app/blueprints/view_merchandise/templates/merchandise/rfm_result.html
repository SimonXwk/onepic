{% extends framework_template %}

{# Addiditonal Libraries #}
{% block css_optional %}
{% endblock %}

{% block js_optional %}
{% endblock %}


{# My Own js and css #}
{% block css_custom %}
{% endblock %}

{% block js_custom %}
	{{ import('highchart', ['highcharts-3d', 'boost']) }}
{#	{{ import('echart') }}#}
{% endblock %}


{# Actual Content #}
{% block content %}
	{{ bp_content('rfm_result.html') }}
{% endblock %}


{# Embedded CSS & Javascript #}
{% block css_embedded %}
{% endblock %}

{% block js_embedded_before %}


{% endblock %}



{% block js_embedded_after %}
<script>
const filename = "{{ filename }}";
const rScoreMax = Number("{{ filename.split('_')[-1].split('.')[0].split('-')[0] }}");
const	fScoreMax = Number("{{ filename.split('_')[-1].split('.')[0].split('-')[1] }}");
const	mScoreMax = Number("{{ filename.split('_')[-1].split('.')[0].split('-')[2] }}");
console.log('Max R F M scores: ', rScoreMax, fScoreMax, mScoreMax);


// Use HighChart thousand separator in lang
Highcharts.setOptions({
	lang: {
		decimalPoint: '.',
		thousandsSep: ','
	}
});


function Chart1(data) {
	Highcharts.chart('chart1', {
		chart: {
			type: 'pie',
			options3d: {
				enabled: true,
				alpha: 45,
				beta: 0
			}
		},
		credits: {
			text: 'ⒸTLMA',
			href: '#',
			enabled: true
		},
		title: {
				text: 'Merchandise RFM Segments'
		},
		tooltip: {
				headerFormat: '<b>{series.name}</b><br>',
				pointFormat: '{point.name}: <b>{point.y:,.0f} ({point.percentage:.1f}%)</b>'
		},
		plotOptions: {
				pie: {
						allowPointSelect: true,
						cursor: 'pointer',
						depth: 35,
						dataLabels: {
								enabled: true,
								format: '{point.name}: {point.y:,.0f}'
						}
				}
		},
		series: [{
				type: 'pie',
				name: 'Segments',
				data: data
		}]
	});
}

function Chart2(data) {
	// Give the points a 3D feel by adding a radial gradient
	Highcharts.setOptions({
			colors: $.map(Highcharts.getOptions().colors, function (color) {
					return {
							radialGradient: {
									cx: 0.4,
									cy: 0.3,
									r: 0.5
							},
							stops: [
									[0, color],
									[1, Highcharts.Color(color).brighten(-0.2).get('rgb')]
							]
					};
			})
	});
	// Set up the chart
	let chart = new Highcharts.Chart({
	    chart: {
	        renderTo: 'chart2',
	        margin: 100,
	        type: 'scatter3d',
	        animation: false,
	        options3d: {
	            enabled: true,
	            alpha: 10,
	            beta: 30,
	            depth: 250,
	            viewDistance: 5,
	            fitToPlot: false,
	            frame: {
	                bottom: { size: 1, color: 'rgba(0,0,0,0.02)' },
	                back: { size: 1, color: 'rgba(0,0,0,0.04)' },
	                side: { size: 1, color: 'rgba(0,0,0,0.06)' }
	            }
	        }
	    },
	    title: {
	        text: 'Merchandise RFM Score Combinations'
	    },
	    subtitle: {
	        text: ''
	    },
	    credits: {
	        text: 'ⒸTLMA',
	        href: '#',
	        enabled: true
	    },
	    plotOptions: {
	        scatter: {
	            width: 10,
	            height: 10,
	            depth: 10
	        }
	    },
	    yAxis: {
	        min: 1,
	        max: fScoreMax,
					title:{
	        	text: 'Frequency Score'
					},
					tickPositioner: function(){
	        	return Array.from({length:fScoreMax},(v,k)=>k+1)
					},
	    },
	    xAxis: {
	        min: 1,
	        max: rScoreMax,
	        gridLineWidth: 1,
					title:{
	        	text: 'Recency Score'
					},
					tickPositioner: function(){
	        	return Array.from({length:rScoreMax},(v,k)=>k+1)
					},
	    },
	    zAxis: {
	        min: 1,
	        max: mScoreMax,
					title:{
	        	margin: 10,
	        	text: 'Monetary Score'
					},
	        showFirstLabel: false,
					tickPositioner: function(){
	        	return Array.from({length:mScoreMax},(v,k)=>k+1)
					},
	    },
	    legend: {
	        enabled: false
	    },
	    series: [{
	        name: 'RFM SCORES',
				 	{#type: 'bubble',#}
	        colorByPoint: true,
	        data:data
	    }]
	});
	// Add mouse and touch events for rotation
	(function (H) {
	    function dragStart(eStart) {
	        eStart = chart.pointer.normalize(eStart);

	        let posX = eStart.chartX,
	            posY = eStart.chartY,
	            alpha = chart.options.chart.options3d.alpha,
	            beta = chart.options.chart.options3d.beta,
	            sensitivity = 5; // lower is more sensitive

	        function drag(e) {
	            // Get e.chartX and e.chartY
	            e = chart.pointer.normalize(e);

	            chart.update({
	                chart: {
	                    options3d: {
	                        alpha: alpha + (e.chartY - posY) / sensitivity,
	                        beta: beta + (posX - e.chartX) / sensitivity
	                    }
	                }
	            }, undefined, undefined, false);
	        }

	        chart.unbindDragMouse = H.addEvent(document, 'mousemove', drag);
	        chart.unbindDragTouch = H.addEvent(document, 'touchmove', drag);

	        H.addEvent(document, 'mouseup', chart.unbindDragMouse);
	        H.addEvent(document, 'touchend', chart.unbindDragTouch);
	    }
	    H.addEvent(chart.container, 'mousedown', dragStart);
	    H.addEvent(chart.container, 'touchstart', dragStart);
	}(Highcharts));
}

// Using Fetch API to grab data
const endpoint = '/api/merch/rfm/'+ filename;
console.log('Fetching endpoint: ' + endpoint);
fetch(endpoint).then(function(response){
		// console.log(response);
		if (response.status !== 200) {
        console.log('Looks like there was a problem. Status Code: ' + response.status);
        return;
		}
		console.log('Response: 200');
		// Examine the text in the response
    response.json().then(function (json) {
    	// Process json data after response.json()
			// ---------------------------------------------------------------------------------
	    console.log('Response JSON: ', json);

			console.log("-----------------------------");
			//let raw =  json.rfm.rows;
			//raw  = Object.keys(raw).map(function (key) {
			//	return [raw[key]['recency'],raw[key]['frequency'],raw[key]['monetary_value']]
	  	//});
			{#console.log(raw);#}

			console.log("-----------------------------");
			let segment = json.segments.actuals;
			segment  = Object.keys(segment).map(function (key) {
				return [key, segment[key]]
	  	});
			console.log(segment);
			Chart1(segment);

			console.log("-----------------------------");
			let scores = json.rfm.scores;
			scores  = Object.keys(scores).map(function (key) {
				return [Number(String(key).substring(0, 1)),Number(String(key).substring(1, 2)),Number(String(key).substring(2, 3))]
				//return {x:Number(String(key).substring(0, 1)), y:Number(String(key).substring(1, 2)),z:Number(String(key).substring(2, 3)),w:scores[key]};
	  	});
			console.log(scores);
			Chart2(scores);
			// ---------------------------------------------------------------------------------
    }) //end of response.json().then()
});


</script>


{#	{{ bp_js("result") }}#}
{% endblock %}




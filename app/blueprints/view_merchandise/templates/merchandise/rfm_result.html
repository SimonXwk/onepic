{% extends framework_template %}

{# Addiditonal Libraries #}
{% block css_optional %}
{% endblock %}

{% block js_optional %}
{{ Highchart(['highcharts-3d'], ['boost']) }}
{% endblock %}
{# ------------------------------------------------------------------- #}


{# My Own js and css #}
{% block css_custom %}
{% endblock %}

{% block js_custom %}
{% endblock %}
{# ------------------------------------------------------------------- #}


{# Embedded CSS #}
{% block css_embedded %}
{% endblock %}
{# ------------------------------------------------------------------- #}


{# Embedded Javascript After Libraries & Before Custom Javascript #}
{% block js_embedded_before %}
{% endblock %}
{# ------------------------------------------------------------------- #}


{# Embedded Javascript At the Very End #}
{% block js_embedded_after %}
<script>
const filename = "{{ filename }}";
const rScoreMax = Number("{{ filename.split('_')[-1].split('.')[0].split('-')[0] }}");
const fScoreMax = Number("{{ filename.split('_')[-1].split('.')[0].split('-')[1] }}");
const mScoreMax = Number("{{ filename.split('_')[-1].split('.')[0].split('-')[2] }}");
console.log('Maximum R, F and M scores applied: ', rScoreMax, fScoreMax, mScoreMax);


{#let chart1 = new Highcharts.Chart({#}
{#	chart: {#}
{#		renderTo: 'chart1',#}
{#		type: 'pie',#}
{#		options3d: {#}
{#			enabled: true,#}
{#			alpha: 45,#}
{#			beta: 0#}
{#			}#}
{#	},#}
{#});#}

function SegmentPie(chartID, data) {
	// Customize Pie Chart Color
	Highcharts.setOptions({
     colors: ['#50B432', '#ED561B', '#DDDF00', '#24CBE5', '#64E572', '#FF9655', '#FFF263',      '#6AF9C4']
	});

	Highcharts.chart(chartID, {
		chart: {
			type: 'pie',
			options3d: {
				enabled: true,
				alpha: 45,
				beta: 0
			}
		},

		title: {
				text: 'Merchandise RFM Segments'
		},
		tooltip: {
				headerFormat: '<b>{series.name}</b><br>',
				pointFormat: '{point.name}: <b>{point.y:,.0f} ({point.percentage:.1f}%)</b>'
		},
		plotOptions: {
				pie: {
						allowPointSelect: true,
						cursor: 'pointer',
						depth: 35,
						dataLabels: {
								enabled: true,
								format: '{point.name}: {point.y:,.0f}'
						}
				}
		},
		series: [{
				type: 'pie',
				name: 'Segments',
				showInLegend: true,
				data: data
		}]
	});
}


function RFSegmentScatter(chartID, data) {
	Highcharts.chart(chartID, {
			chart: {
					type: 'scatter',
					zoomType: 'xy'
			},
			title: {
					text: 'Recency and Frequency by Segments'
			},
			xAxis: {
					title: {
							enabled: true,
							text: 'Recency (days)'
					},
					min: 0,
					startOnTick: true,
					endOnTick: true,
					showLastLabel: true
			},
			yAxis: {
					title: {
							text: 'Frequency (number of orders)'
					},
					min: 0
			},
			legend: {
					layout: 'vertical',
					align: 'left',
					verticalAlign: 'top',
					x: 100,
					y: 70,
					floating: true,
					backgroundColor: (Highcharts.theme && Highcharts.theme.legendBackgroundColor) || '#FFFFFF',
					borderWidth: 1
			},
			plotOptions: {
					scatter: {
							marker: {
									radius: 5,
									states: {
											hover: {
													enabled: true,
													lineColor: 'rgb(100,100,100)'
											}
									}
							},
							states: {
									hover: {
											marker: {
													enabled: false
											}
									}
							},
							tooltip: {
									headerFormat: '<b>{series.name}</b><br>',
									pointFormat: '{point.x} days, {point.y} orders'
							}
					}
			},
			series: [{
					name: 'Segment: All',
					color: 'rgba(223, 83, 83, .5)',
					data: data

			}]
	});


}

function RFM3dScatter(chartID, data) {
	// Give the points a 3D feel by adding a radial gradient
	Highcharts.setOptions({
			colors: $.map(Highcharts.getOptions().colors, function (color) {
					return {
							radialGradient: {
									cx: 0.4,
									cy: 0.3,
									r: 0.5
							},
							stops: [
									[0, color],
									[1, Highcharts.Color(color).brighten(-0.2).get('rgb')]
							]
					};
			})
	});
	// Set up the chart
	let chart = new Highcharts.Chart({
	    chart: {
	        renderTo: chartID,
	        margin: 100,
	        type: 'scatter3d',
	        animation: false,
	        options3d: {
	            enabled: true,
	            alpha: 10,
	            beta: 30,
	            depth: 250,
	            viewDistance: 5,
	            fitToPlot: false,
	            frame: {
	                bottom: { size: 1, color: 'rgba(0,0,0,0.02)' },
	                back: { size: 1, color: 'rgba(0,0,0,0.04)' },
	                side: { size: 1, color: 'rgba(0,0,0,0.06)' }
	            }
	        }
	    },
	    title: {
	        text: 'Merchandise RFM Score Combinations'
	    },
	    subtitle: {
	        text: ''
	    },
	    plotOptions: {
	        scatter: {
	            width: 10,
	            height: 10,
	            depth: 10
	        }
	    },
	    yAxis: {
	        min: 1,
	        max: fScoreMax,
					title:{
	        	text: 'Frequency Score'
					},
					tickPositioner: function(){
	        	return Array.from({length:fScoreMax},(v,k)=>k+1)
					},
	    },
	    xAxis: {
	        min: 1,
	        max: rScoreMax,
	        gridLineWidth: 1,
					title:{
	        	text: 'Recency Score'
					},
					tickPositioner: function(){
	        	return Array.from({length:rScoreMax},(v,k)=>k+1)
					},
	    },
	    zAxis: {
	        min: 1,
	        max: mScoreMax,
					title:{
	        	margin: 10,
	        	text: 'Monetary Score'
					},
	        showFirstLabel: false,
					tickPositioner: function(){
	        	return Array.from({length:mScoreMax},(v,k)=>k+1)
					},
	    },
	    legend: {
	        enabled: false
	    },
	    series: [{
	        name: 'RFM SCORES',
				 	{#type: 'bubble',#}
	        colorByPoint: true,
	        data:data
	    }]
	});
	// Add mouse and touch events for rotation
	(function (H) {
	    function dragStart(eStart) {
	        eStart = chart.pointer.normalize(eStart);

	        let posX = eStart.chartX,
	            posY = eStart.chartY,
	            alpha = chart.options.chart.options3d.alpha,
	            beta = chart.options.chart.options3d.beta,
	            sensitivity = 5; // lower is more sensitive

	        function drag(e) {
	            // Get e.chartX and e.chartY
	            e = chart.pointer.normalize(e);

	            chart.update({
	                chart: {
	                    options3d: {
	                        alpha: alpha + (e.chartY - posY) / sensitivity,
	                        beta: beta + (posX - e.chartX) / sensitivity
	                    }
	                }
	            }, undefined, undefined, false);
	        }

	        chart.unbindDragMouse = H.addEvent(document, 'mousemove', drag);
	        chart.unbindDragTouch = H.addEvent(document, 'touchmove', drag);

	        H.addEvent(document, 'mouseup', chart.unbindDragMouse);
	        H.addEvent(document, 'touchend', chart.unbindDragTouch);
	    }
	    H.addEvent(chart.container, 'mousedown', dragStart);
	    H.addEvent(chart.container, 'touchstart', dragStart);
	}(Highcharts));
}

// Fetching Data from API and draw charts
fetchJSON(endpoint('/api/merch/rfm/', filename), function(json){
	// Reading Segments
	let segment = json.segments.actuals;
	let segmentDef = json.segments.definition;
	segment  = Object.keys(segment).map(function (key) {
		return {name:key, y:segment[key], color:segmentDef[key]['color']}
	});
	console.log('Segments: ', segment);
	SegmentPie('chart1', segment);

	// Read R, F, and Segment
	let raw =  json.rfm.rows;
	raw  = Object.keys(raw).map(function (key) {
		return [raw[key]['recency'],raw[key]['frequency']]
	});
	console.log('R F raw: ',raw);
	RFSegmentScatter('chart2', raw);

	// Reading RFM Scores
	let scores = json.rfm.scores;
	scores  = Object.keys(scores).map(function (key) {
		return [Number(String(key).substring(0, 1)),Number(String(key).substring(1, 2)),Number(String(key).substring(2, 3))]
		//return {x:Number(String(key).substring(0, 1)), y:Number(String(key).substring(1, 2)),z:Number(String(key).substring(2, 3)),w:scores[key]};
	});
	console.log('RFM Scores: ', scores);
	RFM3dScatter('chart3', scores);
});


</script>
{% endblock %}
{# ------------------------------------------------------------------- #}
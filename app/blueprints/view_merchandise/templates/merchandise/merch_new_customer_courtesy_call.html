{% extends framework_template %}

{# Addiditonal Libraries #}
{% block css_optional %}
{% endblock %}

{% block js_optional %}
{{ import('vue') }}
{{ import('datatables', ['bs4']) }}
{% endblock %}
{# ------------------------------------------------------------------- #}


{# My Own js and css #}
{% block css_custom %}
{% endblock %}

{% block js_custom %}
{% endblock %}
{# ------------------------------------------------------------------- #}


{# Embedded CSS #}
{% block css_embedded %}
<style type="text/css">
/* slide */
.slide-fade-enter-active {
  transition: all .3s ease;
}
.slide-fade-leave-active {
  transition: all .8s cubic-bezier(1.0, 0.5, 0.8, 1.0);
}
.slide-fade-enter, .slide-fade-leave-to
/* .slide-fade-leave-active below version 2.1.8 */ {
  transform: translateX(10px);
  opacity: 0;
}

/* bounce */
.bounce-enter-active {
  animation: bounce-in .5s;
}
.bounce-leave-active {
  animation: bounce-in .5s reverse;
}
@keyframes bounce-in {
  0% {
    transform: scale(1.02);
  }
  50% {
    transform: scale(0.98);
  }
  100% {
    transform: scale(1);
  }
}
</style>
{% endblock %}
{# ------------------------------------------------------------------- #}


{# Embedded Javascript After Libraries & Before Custom Javascript #}
{% block js_embedded_before %}
{% endblock %}
{# ------------------------------------------------------------------- #}


{# Embedded Javascript At the Very End #}
{% block js_embedded_after %}
<script>
const vueBus = new Vue();

let vueColumn = Vue.component('vue-column', {
	props: ['orderNumber', 'row'],
	data: function(){
		return {
			fetch1: '/api/ssi/orders/search/',
			fetch2: '/api/ssi/track/',
			fetch3: '/api/ssi/order/',
			trackingNumber: null,
			called1: false,
			called2: false,
			orders: 0,
			trackingNumberExists: false,
			orderID: null,
			status: null,
			statusDate: null,
			statusDetail: null,
		}
	},
	computed: {
		ausLink: function(){
			return 'https://auspost.com.au/mypost/track/#/details/' + this.trackingNumber
		},
		showing: function(){
			return this.skip || this.status !== null && this.status.toUpperCase().indexOf('DELIVERED') !== -1
		},
		skip: function(row){
			return this.row['FIRSTDATE_MERCHANDISE_PURCHASE'] + this.row['FIRSTDATE_MERCHANDISE_OTHER'] + this.row['FIRSTDATE_MERCHANDISE_PLEDGE'] === 0
		},
		showType: function(){
			if(this.skip) {
				return -2
			}else if ( this.called1 === false ) {
				return 0
			}else if ( this.trackingNumber === null ) {
				return 2
			}else if ( this.called2 === false ) {
				return 0
			}else if ( this.status !== null && this.status.toUpperCase().indexOf('DELIVERED') !== -1 ) {
				return -1
			}else {
				return 1
			}
		},
		callDisplay : function () {
			if(this.skip) {
				this.show = true;
				return '✅' + ' ' + 'Call Directly : Pure Donation or GOL ❤'
			}else if ( this.called1 === false ) {
				this.show = false;
				return '☕' + ' searching ... step 1'
			}else if ( this.trackingNumber === null ) {
				this.show = false;
				return '☹' + ' Not Found (Starshipit)'
			}else if ( this.called2 === false ) {
				this.show = false;
				return '☕' + ' searching ... step 2'
			}else if ( this.status !== null && this.status.toUpperCase().indexOf('DELIVERED') !== -1 ) {
				this.show = true;
				return '✅' + ' ['+ this.orders + '] ' + this.status + ' ⛟ ' + this.formatDateTime(this.statusDate) + ''
			}else {
				this.show = false;
				return '❌' + ' ['+ this.orders + '] ' + this.status
			}
		}
	},
	created(){
		let vCol = this;
		fetchJSON(endpoint(vCol.fetch1 + vCol.orderNumber), function (json1) {
			vCol.called1 = true;
			let orders = json1.orders;
			if(orders.length>0){
				vCol.orders = orders.length;
				vCol.trackingNumber = orders[0]['tracking_number'];
				orders.forEach(order => {
					fetchJSON(endpoint(vCol.fetch2 + vCol.trackingNumber), function (json2) {
						vCol.called2 = true;
						if(json2.success === true){
							let events = json2['results']['tracking_events'];
							let lastEvent = events[events.length - 1];
							vCol.status = lastEvent['status'];
							vCol.statusDate = lastEvent['event_datetime'];
							vCol.statusDetail = lastEvent['details'];
						}
					});
				});

			}

		});
	},
	template:`
	<transition name="bounce">
	<tr v-if="showType < 0">
		<td scope="row">
			<small class="text-danger"><< row.SERIALNUMBER >></small> <strong><< row.FULLNAME >></strong>
			<span v-if="(row.MOBILENUMBER !== null && row.MOBILENUMBER.trim() !== '')" class="text-info"><br>
				<small>&#9742;</small> Mobile Phone: << row.MOBILENUMBER >>
			</span>
			<span v-if="(row.DAYTELEPHONE !== null && row.DAYTELEPHONE.trim() !== '')" class="text-info"><br>
				<small>&#9742;</small> Day Phone : << row.DAYTELEPHONE >>
			</span>
			<span v-if="(row.EVENINGTELEPHONE !== null && row.EVENINGTELEPHONE.trim() !== '')" class="text-info"><br>
				<small>&#9742;</small> Evening Phone : << row.EVENINGTELEPHONE >>
			</span>
			<span class="text-muted"
				v-if="!(row.MOBILENUMBER !== null && row.MOBILENUMBER.trim() !== '') && !(row.DAYTELEPHONE !== null && row.DAYTELEPHONE.trim() !== '') && !(row.EVENINGTELEPHONE !== null && row.EVENINGTELEPHONE.trim() !== '') "
			>
				<br><small><s>Phone Number Not Found</s></small>
			</span>
		</td>

		<td >
			 << orderNumber >><small><span class="text-secondary"> placed on << formatDate(row.FIRSTDATE) >></span></small>
			 <br>
			 <a v-if="showType === -1" target="blank" v-bind:href="ausLink"><< callDisplay >></a>
			 <span v-else class="text-danger"><< callDisplay >></span>
		</td>

		<td>
			<span v-if=" row.BOARDEDBY !== null ">
				<mark>&#9924; << row.BOARDEDBY >></mark>
				<br>
				<small class="text-success">Boarded this contact already</small>
			</span>
			<span v-else></span>
		</td>

	</tr>
	</transition>
	`,
	methods:{
		formatDate: function (rawDate){
			let d = new Date(rawDate);
			return d.toLocaleDateString("en-AU", { year: 'numeric', month: 'long', day: 'numeric' });
		},
		formatDateTime: function (rawDate){
			let d = new Date(rawDate);
			return d.toLocaleDateString("en-AU", { year: 'numeric', month: 'long', day: 'numeric' , hour:'numeric', minute:'numeric' });
		},
	}
	}
);

let vueTable = Vue.component('vue-table', {
	props: ['rows', 'theme'],
	data: function() {
		return {
			headers: ['CUSTOMER', 'CALL ACTION', 'ON BOARDING PROFILE'],
			orders: null,
			ordersPrepared: false,
			fetch1: '/api/ssi/orders/search/',
			fetch2: '/api/ssi/track/',
			fetch3: '/api/ssi/order/',
			tableID: 'CallList',
			loader: '<div class="container h-100"><div class="row h-100 justify-content-center align-items-center"><div class="loader2"><span></span><span></span><span></span></div></div></div>',

		}
	},
	created(){
		this.orders={};
		this.ordersPrepared = false;
		for (let i=0; i < this.rows.length; i++){
			let orderID = this.rows[i]['FIRSTORDER'];
			this.orders[orderID] = {
				status: null
			};
			this.ordersPrepared = true;
		}
	},
	mounted(){
		$('#' + this.tableID).DataTable({
				stateSave: true,
				"lengthMenu": [[-1, 3, 5, 7, 10, 15, 20, 25, 50, 100 ], [ "All", 3, 5, 7, 10, 15, 20, 25, 50, 100 ]],
		});
	},
	components:{
		'starship-column': vueColumn
	},
	template: `
	<div class="table-responsive-lg">
		<table class="table table-sm table-hover table-bordered" id="vue-table">
			<thead>
				<tr class="table-bordered " v-bind:class="{'table-success': theme === 'success', 'table-warning': theme === 'warning' , 'table-info': theme === 'info', 'table-danger': theme === 'danger'}">
					 <th scope="col" v-for="header in headers"><< header >></th>
				</tr>
			</thead>
			<tbody>
				<starship-column v-for="row in rows" v-bind:orderNumber='row.FIRSTORDER' v-bind:row='row'></starship-column>
			</tbody>
		</table>
 	</div>
	`,
	methods:{
	}
});



let rootVue = new Vue({
	el: '#vue',
	data: {
		raw: {
			rows: null,
			ready: false,
			timestamp: undefined,
		},

	},
	template: `
	<div v-if="!raw.ready">

		<div class="row">
			<div class="col-12">
				<div class="alert alert-light text-center" role="alert">
					<p class="lead">Finding New Merchandise Customers in ThankQ ... </p>
					<p><div class="container h-100"><div class="row h-100 justify-content-center align-items-center"><div class="loader1"></div></div></div></p>
				</div>
			</div>
		</div>

	</div>

	<div v-else>
		<div class="row">
			<div class="col-12">

				<h4 class="text-dark"><< raw.rows.length >> New Merchandise Customers Found</h4>
				<p class="lead font-weight-light text-info"><small>List Refreshed : << raw.timestamp >></small></p>

				<ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">

					<li class="nav-item shadow-type1">
						<a class="nav-link active" id="include-tab" data-toggle="pill" href="#include" role="tab" aria-controls="include" aria-selected="true">
						 &#9742; Courtesy Call List <span class="badge badge-pill badge-info"> << includeRows.length >></span>
						</a>
					</li>
					<li class="nav-item shadow-type1">
						<a class="nav-link" id="exclude-tab" data-toggle="pill" href="#exclude" role="tab" aria-controls="exclude" aria-selected="false">
						 &#9940; Ignored <span class="badge badge-pill badge-warning"> << excludeRows.length >></span>
						</a>
					</li>
					<li class="nav-item shadow-type1">
						<a class="nav-link" id="finished-tab" data-toggle="pill" href="#finished" role="tab" aria-controls="finished" aria-selected="false">
						 &#9749; Finished <span class="badge badge-pill badge-success"> << finishedRows.length >></span>
						</a>
					</li>

				</ul>

				<div class="tab-content" id="pills-tabContent">

					<div class="tab-pane fade show active" id="include" role="tabpanel" aria-labelledby="include-tab">
						<vue-table v-bind:rows="includeRows" theme="info"></vue-table>
					</div>

					<div class="tab-pane fade" id="exclude" role="tabpanel" aria-labelledby="exclude-tab">
						<vue-table v-bind:rows="excludeRows" theme="warning"></vue-table>
					</div>

					<div class="tab-pane fade" id="finished" role="tabpanel" aria-labelledby="finished-tab">
						<vue-table v-bind:rows="finishedRows" theme="success"></vue-table>
					</div>

				</div>

			</div>
		</div>

	</div>
	`,
	computed: {
		includeRows: function () {
			return this.raw.rows.filter(row => !this.excludeRow(row) && this.skipRow(row))
		},
		excludeRows: function () {
			return this.raw.rows.filter(row => this.excludeRow(row) )
		},
		finishedRows: function () {
			return this.raw.rows.filter(row => !this.excludeRow(row) && !this.skipRow(row) )
		}
	},
	methods:{
		excludeRow: function(row){
			return (row['CONTACTTYPE'] === 'Organisation')
					|| (row['PRIMARYCATEGORY'] === 'ESTATE')
					|| (row['DECD'] === -1)
					|| (row['FIRSTDATE_MERCHANDISE_TOTAL'] === row['FIRSTDATE_MERCHANDISE_PLEDGE'])
		},
		skipRow: function(row){
			return (row['CALLEDBY'] === null )
					|| (row['CALLEDBY'].trim() === '' )
		}
	},
	components:{
		'vue-table': vueTable,
	},
	created(){
		fetchJSON(endpoint('/api/merch/new_customers'), function(json){
			rootVue.raw.rows = json;
			rootVue.raw.ready = true;
			rootVue.raw.timestamp = new Date();
			rootVue.raw.timestamp = rootVue.raw.timestamp.toLocaleString()
		});
	}
});


</script>
{% endblock %}
{# ------------------------------------------------------------------- #}